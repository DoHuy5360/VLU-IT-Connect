<template>
  <tr>
    <td class="text-center">
      <input type="checkbox" v-model="selected" @change="emitSelection" />
    </td>

    <td class="text-left d-flex align-items-center" :style="{ paddingLeft: `${20 * category.nestDepth}px` }">
      <button v-if="hasChildren" class="btn btn-sm btn-link p-0 me-2" @click="toggleChildren(category.id)">
        <i :class="isExpanded ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"></i>
      </button>
      <span @click="toggleChildren(category.id)" class="cursor-pointer">
        {{ category.name }}
      </span>
    </td>

    <td class="text-center">{{ category.description }}</td>
    <td class="text-center">
      <button class="btn btn-sm btn-primary" @click="$router.push(`/administrator/category/edit/${category.code}`)">
        <i class="fa fa-edit"></i> S·ª≠a
      </button>
      <button class="btn btn-sm btn-danger" @click="confirmDelete">
        <i class="fa fa-trash"></i> X√≥a
      </button>
    </td>
  </tr>

  <!-- Hi·ªÉn th·ªã danh m·ª•c con ngay khi danh m·ª•c cha m·ªü -->
  <template v-if="hasChildren && isExpanded">
    <CategoryRow
      v-for="child in category.children"
      :key="child.id"
      :category="child"
      :expandedCategories="expandedCategories"
      @edit="$emit('edit', child)"
      @delete="$emit('delete', child)"
      @toggle="toggleChildren"
    />
  </template>
</template>

<script>
import axios from "axios";
import Swal from "sweetalert2";
import { useToast } from "vue-toastification";

export default {
  name: "CategoryRow",
  props: {
    category: { type: Object, required: true },
    expandedCategories: { type: Object, required: true },
  },
  emits: ["edit", "delete", "toggle"],
  data() {
    return {
      selected: false,
    };
  },
  computed: {
    hasChildren() {
      return this.category.children && this.category.children.length > 0;
    },
    isExpanded() {
      return !!this.expandedCategories[this.category.id];
    },
  },
  methods: {
    toggleChildren(categoryId) {
      this.$emit("toggle", categoryId);
    },
    emitSelection() {
      this.$emit("select", { id: this.category.id, selected: this.selected });
    },
    async confirmDelete() {
      const toast = useToast();
      const result = await Swal.fire({
        title: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c "${this.category.name}"?`,
        text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "X√≥a ngay",
        cancelButtonText: "H·ªßy",
      });

      if (result.isConfirmed) {
        try {
          const token = localStorage.getItem("authToken");
          console.log(`üöÄ Deleting category: ${this.category.code}`);

          const response = await axios.delete("https://localhost:7017/api/Categories/deletecategory", {
            headers: { Authorization: token },
            params: { cateCode: this.category.code }, // Truy·ªÅn cateCode trong params
          });

          if (response.status === 200) {
            toast.success("Danh m·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!");
            this.$emit("delete", this.category); // Emit event ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
          }
        } catch (error) {
          console.error("‚ùå L·ªói khi x√≥a danh m·ª•c:", error.response?.data || error.message);
          toast.error("X√≥a danh m·ª•c th·∫•t b·∫°i!");
        }
      }
    },
  },
};
</script>
